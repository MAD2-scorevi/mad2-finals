rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Helper function to check if user is owner
    function isOwner() {
      return isAuthenticated() && getUserRole() == 'owner';
    }

    // Helper function to check if user is regular user
    function isUser() {
      return isAuthenticated() && getUserRole() == 'user';
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Admins can read all users
      allow read: if isAdmin();

      // Users can update their own data (except role and uid)
      allow update: if isAuthenticated() && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid']);

      // Admins can update any user
      allow update: if isAdmin();

      // Only system can create users (through Firebase Auth registration)
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Admins can delete users
      allow delete: if isAdmin();
    }

    // Products collection
    match /products/{productId} {
      // Everyone can read products (even unauthenticated users)
      allow read: if true;

      // Only owners and admins can create, update, delete products
      allow create, update, delete: if isOwner() || isAdmin();
    }

    // Inventory collection
    match /inventory/{productId} {
      // Everyone can read inventory (for browsing products)
      allow read: if true;

      // Only admins can create, update, delete inventory items
      allow create, update, delete: if isAdmin();
    }

    // Orders collection
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Admins and owners can read all orders
      allow read: if isAdmin() || isOwner();

      // Users can create their own orders
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own orders (for cancellation, etc.)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Admins and owners can update any order
      allow update: if isAdmin() || isOwner();

      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // Inventory collection
    match /inventory/{productId} {
      // Everyone can read inventory (for browsing products)
      allow read: if true;

      // Only admins can create, update, delete inventory items
      allow create, update, delete: if isAdmin();
    }

    // Categories collection (example)
    match /categories/{categoryId} {
      // Everyone can read categories
      allow read: if true;

      // Only admins can create, update, delete categories
      allow create, update, delete: if isAdmin();
    }

    // Cart collection (example)
    match /cart/{cartId} {
      // Users can only access their own cart
      allow read, write: if isAuthenticated() && request.auth.uid == cartId;

      // Admins can read all carts
      allow read: if isAdmin();
    }
  }
}

