rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to get user role
    function getUserRole() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role;
    }

    // Helper function to check if user is admin
    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    // Helper function to check if user is owner
    function isOwner() {
      return isAuthenticated() && getUserRole() == 'owner';
    }

    // Helper function to check if user is regular user
    function isUser() {
      return isAuthenticated() && getUserRole() == 'user';
    }

    // Users collection
    match /users/{userId} {
      // Users can read their own data
      allow read: if isAuthenticated() && request.auth.uid == userId;

      // Admins and Owners can read all users (both get and list operations)
      allow read, list: if isAdmin() || isOwner();

      // Users can update their own data (except role, uid, and status)
      allow update: if isAuthenticated() && request.auth.uid == userId
                    && !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'uid', 'status']);

      // Admins and Owners can update any user (including status for deactivation)
      // But cannot change role to/from owner
      allow update: if (isAdmin() || isOwner())
                    && !(resource.data.role == 'owner' || request.resource.data.role == 'owner');

      // Only system can create users (through Firebase Auth registration)
      // Admins can also create users
      allow create: if isAuthenticated() && (request.auth.uid == userId || isAdmin() || isOwner());

      // Admins and Owners can delete users (but soft delete is preferred)
      allow delete: if isAdmin() || isOwner();
    }

    // Products collection
    match /products/{productId} {
      // Everyone can read products (even unauthenticated users)
      allow read: if true;

      // Only owners and admins can create, update, delete products
      allow create, update, delete: if isOwner() || isAdmin();
    }

    // Inventory collection
    match /inventory/{productId} {
      // Everyone can read inventory (for browsing products)
      allow read: if true;

      // Admins and owners can create, update, delete inventory items
      allow create, update, delete: if isAdmin() || isOwner();

      // Allow authenticated users to update stock quantity only (for order placement)
      allow update: if isAuthenticated()
                    && request.resource.data.stockQuantity < resource.data.stockQuantity
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['stockQuantity', 'lastUpdated']);
    }

    // Orders collection
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Admins and owners can read all orders
      allow read: if isAdmin() || isOwner();

      // Users can create their own orders
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;

      // Users can update their own orders (for cancellation, etc.)
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // Admins and owners can update any order
      allow update: if isAdmin() || isOwner();

      // Only admins can delete orders
      allow delete: if isAdmin();
    }

    // User Activities collection
    match /user_activities/{activityId} {
      // Authenticated users can create activity logs
      allow create: if isAuthenticated();

      // Admins and owners can read all activities
      allow read: if isAdmin() || isOwner();

      // No one can update or delete activities (audit trail)
      allow update, delete: if false;
    }

    // Categories collection (example)
    match /categories/{categoryId} {
      // Everyone can read categories
      allow read: if true;

      // Only admins can create, update, delete categories
      allow create, update, delete: if isAdmin();
    }

    // Cart collection (example)
    match /cart/{cartId} {
      // Users can only access their own cart
      allow read, write: if isAuthenticated() && request.auth.uid == cartId;

      // Admins can read all carts
      allow read: if isAdmin();
    }
  }
}

